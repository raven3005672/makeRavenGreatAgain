# Webpack

tapable: 发布订阅模式

## webpack

主要作用：模块打包、编译兼容、能力拓展
运行流程：初始化参数，开始编译，确定入口，编译模块，完成模块编译，输出资源，输出完成
- 初始化：启动构建，读取合并配置，加载plugin，实例化compiler
- 编译：从entry出发，对每个module串行调用对应的loader去翻译文件内容，再找到该module依赖的module，递归地进行编译处理
- 输出：将编译后的module组合成chunk，将chunk转换成文件，输出到文件系统中

loader解析文件内容，文件加载器
plugin赋予打包功能（打包优化、资源管理、环境变量注入等）

entry ==> loader ==> output
 |--------plugin--------|

## 文件指纹策略

- hash - 项目单位，项目内容变化则变化，
- chunkhash - chunk单位，文件内容变化则变化
- contenthash - 自身内容单位

css推荐使用contenthash
js推荐chunkhash

## webpack热更新原理

HMR - hot module replacement,

核心是客户端从服务端拉取更新后的文件，准确的说是chunk diff（chunk需要更新的部分），webpack-dev-server与浏览器之间维护了一个websocket，当本地资源发生变化时，会想浏览器推送更新，并带上构建时的hash，让客户端与上一次资源进行对比。客户端对比出差异后会向server发起ajax请求来获取更改内容（文件列表，hash），这样客户端就可以再借助这些信息继续向server发起jsonp请求获取该chunk的增量更新。

后续的部分（如何处理，如何保留，如何更新）由HotModulePlugin来完成，提供了相关API以供开发者针对自身场景进行处理，像react-hot-loader和vue-loader

## vite和webpack相比有什么优点

- vite服务启动更快
  - vite把应用中的模块区分为**依赖**和**源码**两类，依赖使用esbuild进行依赖与构建，源码使用esmodule的形式，浏览器直接解析esmodule，也可以通过动态导入、路由懒加载等方式，在对应页面才去加载该页面的资源。
- vite热更新更快
  - HMR是在原生esm上执行的，当编辑一个文件时，只需要精确地使已编辑的模块与其最近的HMR边界之间的链失活。
  - 同时利用HTTP头来加速，源码模块的请求根据304 Not Modified进行协商缓存，依赖模块会通过cache-control进行强缓存


