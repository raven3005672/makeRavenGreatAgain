# zustand

- 单例对象
- 观察者模式

```JS
function createStore(initState) {
  const listeners = new Set(); // 监听事件
  const state = initState || {};
  const setState = (newState) => {
    listeners.forEach((listener) => listener(newState, state));
    state = newState;
  }
  const getState = () => state;
  const describe = (f) => {
    // 将事件推入listeners
    // 对外提供取消监听方法
    listeners.add(listener);
    return () => listeners.delete(listener);
  }
  const destroy = () => {
    // 清除所有event
    listeners.clear();
  }
}
```

zustand 的 useStore 调用了 useSyncExternalStoreWithSelector 融入了selector逻辑，内部调用了 react 的 useSyncExternalStore

## useSyncExternalStore

单例store + 观察者

- 作用：是用外部数据状态并且状态更新后能发起一个同步更新的hook
- 内部源码实现：则是初始化/更新时，用hook结构保存我们的state&观察者，并且使用的是调度任务（副作用）你可以理解是在源码层面使用了两次useEffect
  - 前一次Effect来注册观察者任务发起更新，后一次任务则是直接来一次比较更新。所以从源码上说，zustand的store是经过了react两次，第一次调用set，触发了观察者中的subscribeToStore的更新，这一次更新完成了old state -> new state
  - 第二次则是由updateStoreInstance发起的更新，这次更新会根据第一次获得的new State来生成我们的ui




## redux

action - reducer - store - view

## mobx

mobx5 - proxy
mobx4 - defineProperty